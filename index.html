<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LLM Token Counter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Optional: nice font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  >

  <style>
    :root {
      color-scheme: dark;
      --bg: #020617;
      --bg-elevated: #0f172a;
      --bg-elevated-soft: #1e293b;
      --bg-input: #0f172a;
      --border-subtle: rgba(148, 163, 184, 0.25);
      --border-strong: rgba(148, 163, 184, 0.5);
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.2);
      --accent-strong: #4ade80;
      --text-main: #f1f5f9;
      --text-soft: #94a3b8;
      --text-softer: #64748b;
      --danger: #f87171;
      --radius-lg: 16px;
      --radius-md: 10px;
      --radius-sm: 6px;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.4);
      --shadow-subtle: 0 1px 3px rgba(0, 0, 0, 0.3);
      --transition-fast: 140ms ease-out;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background:
        radial-gradient(circle at top, rgba(34,197,94,0.12), transparent 55%),
        radial-gradient(circle at bottom, rgba(56,189,248,0.08), transparent 55%),
        #020617;
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .app {
      width: 100%;
      max-width: 1120px;
      margin: auto;
      background: linear-gradient(
        145deg,
        rgba(15, 23, 42, 0.95),
        rgba(15, 23, 42, 0.98)
      );
      border-radius: 24px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      padding: 24px;
      backdrop-filter: blur(28px);
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-badge {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: linear-gradient(135deg, #4ade80, #22c55e);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #022c22;
      font-weight: 800;
      font-size: 18px;
      box-shadow:
        0 0 0 2px rgba(34, 197, 94, 0.3),
        0 8px 20px rgba(34, 197, 94, 0.3);
    }

    .brand-text h1 {
      font-size: 18px;
      margin: 0;
      letter-spacing: 0.02em;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-text h1 span.accent-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
    }

    .brand-text p {
      margin: 0;
      margin-top: 2px;
      font-size: 12px;
      color: var(--text-soft);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pill {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(15, 23, 42, 0.8);
      font-size: 12px;
      color: var(--text-soft);
    }

    .pill strong {
      color: var(--text-main);
    }

    .pill .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.25);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 20px;
    }

    @media (max-width: 900px) {
      .app {
        padding: 16px;
        border-radius: 18px;
      }
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
      header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    .section-card {
      background: var(--bg-elevated);
      border-radius: var(--radius-lg);
      padding: 18px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-subtle);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 14px;
      gap: 12px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.02em;
      color: var(--text-main);
    }

    .section-subtitle {
      font-size: 12px;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      letter-spacing: 0.02em;
      border: 1px solid rgba(34, 197, 94, 0.4);
      color: var(--accent-strong);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(34, 197, 94, 0.1);
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    textarea {
      width: 100%;
      min-height: 280px;
      max-height: 500px;
      resize: vertical;
      background: var(--bg);
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      color: var(--text-main);
      font: 400 13px/1.6 "Inter", system-ui, sans-serif;
      padding: 12px 14px;
      outline: none;
      caret-color: var(--accent);
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    }

    textarea::placeholder {
      color: var(--text-softer);
    }

    textarea:focus-visible {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15);
    }

    .input-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 12px;
      font-size: 12px;
      color: var(--text-soft);
      flex-wrap: wrap;
    }

    .input-toolbar-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .separator-dot {
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: var(--text-softer);
    }

    .input-toolbar-right {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn {
      border-radius: 8px;
      border: 1px solid var(--border-strong);
      background: var(--bg-elevated-soft);
      color: var(--text-main);
      font-size: 12px;
      padding: 6px 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all var(--transition-fast);
      white-space: nowrap;
    }

    .btn span.icon {
      font-size: 14px;
    }

    .btn:hover {
      background: var(--bg-elevated);
      border-color: var(--text-soft);
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-ghost {
      background: transparent;
      border-style: dashed;
      color: var(--text-soft);
    }

    .btn-ghost:hover {
      background: var(--bg-elevated-soft);
      border-style: solid;
      color: var(--text-main);
    }

    .hint {
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .hint code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 11px;
      background: var(--bg);
      padding: 2px 8px;
      border-radius: 6px;
      border: 1px solid var(--border-subtle);
      color: var(--text-main);
    }

    /* Main stats card - FIXED CONTRAST */
    .stats-main-card {
      background: linear-gradient(135deg, #166534 0%, #15803d 50%, #16a34a 100%);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(74, 222, 128, 0.3);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 8px 32px rgba(22, 163, 74, 0.25);
      position: relative;
      overflow: hidden;
    }

    .stats-main-card::before {
      content: "";
      position: absolute;
      top: 0;
      right: 0;
      width: 50%;
      height: 100%;
      background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.1), transparent 60%);
      pointer-events: none;
    }

    .stats-main-card-inner {
      position: relative;
      z-index: 1;
    }

    .stats-main-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
    }

    .model-select-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .label-small {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(255, 255, 255, 0.7);
      font-weight: 500;
    }

    .model-select-wrapper {
      display: flex;
      align-items: center;
      gap: 0;
    }

    select {
      appearance: none;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 8px 32px 8px 12px;
      font-size: 13px;
      font-weight: 500;
      background: rgba(0, 0, 0, 0.25);
      color: #ffffff;
      outline: none;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    select:hover {
      border-color: rgba(255, 255, 255, 0.5);
      background: rgba(0, 0, 0, 0.35);
    }

    select:focus-visible {
      border-color: rgba(255, 255, 255, 0.6);
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.15);
    }

    select option {
      background: #166534;
      color: #ffffff;
    }

    .select-chevron {
      position: relative;
      right: 24px;
      pointer-events: none;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
    }

    .primary-metric {
      text-align: right;
    }

    .primary-metric-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(255, 255, 255, 0.7);
      font-weight: 500;
      margin-bottom: 4px;
    }

    .primary-metric-value {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: #ffffff;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      line-height: 1;
    }

    .primary-metric-sub {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
      margin-top: 6px;
    }

    .stats-main-bottom {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 14px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .stat-chip-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .stat-chip {
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      padding: 4px 10px;
      background: rgba(0, 0, 0, 0.2);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .stat-chip-key {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: rgba(255, 255, 255, 0.7);
    }

    .stat-chip-value {
      font-size: 13px;
      font-weight: 600;
      color: #ffffff;
    }

    .hint-soft {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
      text-align: right;
      max-width: 280px;
    }

    .hint-soft strong {
      color: rgba(255, 255, 255, 0.9);
    }

    .stats-grid {
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 14px;
    }

    .encoding-card,
    .tokens-card {
      background: var(--bg);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      padding: 14px;
      box-shadow: var(--shadow-subtle);
    }

    .encoding-card-header,
    .tokens-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
    }

    .encoding-card-header-title,
    .tokens-card-header-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-soft);
      font-weight: 500;
    }

    .small-pill {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 3px 10px;
      font-size: 11px;
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--bg-elevated);
    }

    .small-pill .dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      border-bottom: 1px solid var(--border-subtle);
    }

    th, td {
      padding: 8px 6px;
      text-align: left;
    }

    th {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-softer);
      font-weight: 500;
      white-space: nowrap;
    }

    tbody tr {
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    tbody tr:last-child {
      border-bottom: none;
    }

    tbody tr:hover {
      background: var(--bg-elevated);
    }

    td {
      color: var(--text-main);
    }

    td.encoding-name-cell {
      font-weight: 500;
    }

    .encoding-models {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .token-count-cell {
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-weight: 500;
    }

    .token-count-cell.primary {
      color: var(--accent-strong);
      font-weight: 700;
    }

    .status-pill {
      font-size: 10px;
      border-radius: 999px;
      padding: 2px 8px;
      border: 1px solid var(--border-subtle);
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: var(--bg-elevated);
    }

    .status-pill.ok {
      border-color: rgba(34, 197, 94, 0.4);
      color: var(--accent-strong);
      background: rgba(34, 197, 94, 0.1);
    }

    .status-pill.error {
      border-color: rgba(248, 113, 113, 0.4);
      color: var(--danger);
      background: rgba(248, 113, 113, 0.1);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--text-softer);
    }

    .status-dot.ok {
      background: var(--accent);
    }

    .status-dot.error {
      background: var(--danger);
    }

    .encoding-muted {
      opacity: 0.5;
    }

    .tokens-body {
      background: var(--bg-elevated);
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
      padding: 10px;
      max-height: 220px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--text-softer) var(--bg);
    }

    .tokens-body::-webkit-scrollbar {
      width: 8px;
    }

    .tokens-body::-webkit-scrollbar-track {
      background: var(--bg);
      border-radius: 4px;
    }

    .tokens-body::-webkit-scrollbar-thumb {
      background: var(--text-softer);
      border-radius: 4px;
    }

    .token-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .token-chip {
      border-radius: 6px;
      border: 1px solid var(--border-subtle);
      background: var(--bg);
      padding: 6px 8px;
      font-size: 11px;
      color: var(--text-main);
      box-shadow: var(--shadow-subtle);
      max-width: 100%;
    }

    .token-text {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 11px;
      white-space: pre-wrap;
      word-wrap: break-word;
      color: var(--text-main);
      margin-bottom: 4px;
    }

    .token-meta {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 9px;
      color: var(--text-softer);
    }

    .token-index,
    .token-id {
      font-variant-numeric: tabular-nums;
    }

    .muted {
      color: var(--text-soft);
      font-size: 12px;
      line-height: 1.5;
    }

    .muted-strong {
      color: var(--text-main);
    }

    footer {
      margin-top: 16px;
      padding-top: 14px;
      border-top: 1px solid var(--border-subtle);
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    footer a {
      color: var(--accent-strong);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    .danger {
      color: var(--danger);
    }

    .message {
      font-size: 11px;
      margin-top: 8px;
      color: var(--accent-strong);
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="brand-badge">Î»</div>
        <div class="brand-text">
          <h1>
            Token Studio
            <span class="accent-dot"></span>
          </h1>
          <p>Accurate LLM token counts in your browser</p>
        </div>
      </div>
      <div class="header-right">
        <div class="pill">
          <span class="status-indicator"></span>
          <strong>Onâ€‘device</strong>
          <span>â€” no prompt upload</span>
        </div>
        <div class="pill">
          <span>Tokenizer:</span>
          <strong>jsâ€‘tiktoken</strong>
        </div>
      </div>
    </header>

    <main class="layout">
      <!-- Left: Input -->
      <section class="section-card">
        <div class="section-header">
          <div>
            <div class="section-title">Prompt Input</div>
            <div class="section-subtitle">
              Paste or type the content you plan to send to the model.
            </div>
          </div>
          <div class="badge">
            <span class="badge-dot"></span>
            <span>Live tokenization</span>
          </div>
        </div>

        <div class="input-toolbar">
          <div class="input-toolbar-left">
            <span>Raw text only</span>
            <span class="separator-dot"></span>
            <span>Chat wrappers not included</span>
          </div>
          <div class="input-toolbar-right">
            <button class="btn" id="pasteBtn" type="button">
              <span class="icon">ðŸ“‹</span>
              <span>Paste</span>
            </button>
            <button class="btn btn-ghost" id="clearBtn" type="button">
              <span class="icon">âœ•</span>
              <span>Clear</span>
            </button>
          </div>
        </div>

        <textarea
          id="inputText"
          placeholder="Type or paste your prompt here. Supports large prompts; token counts update as you type."
        ></textarea>

        <div class="hint">
          <span>Tip: This counts <span class="muted-strong">raw tokens</span> for the text above.</span>
          <span>Tokenizer: <code>jsâ€‘tiktoken</code></span>
        </div>
        <div id="inputMessage" class="message"></div>
      </section>

      <!-- Right: Stats -->
      <section class="section-card">
        <div class="stats-main-card">
          <div class="stats-main-card-inner">
            <div class="stats-main-top">
              <div class="model-select-group">
                <div class="label-small">Primary Model</div>
                <div class="model-select-wrapper">
                  <select id="primaryModel">
                    <!-- Options populated via JS -->
                  </select>
                  <span class="select-chevron">â–¾</span>
                </div>
              </div>
              <div class="primary-metric">
                <div class="primary-metric-label">Tokens (text only)</div>
                <div class="primary-metric-value" id="primaryTokens">0</div>
                <div class="primary-metric-sub" id="primaryModelLabel">â€”</div>
              </div>
            </div>
            <div class="stats-main-bottom">
              <div class="stat-chip-row">
                <div class="stat-chip">
                  <span class="stat-chip-key">Chars</span>
                  <span class="stat-chip-value" id="charCount">0</span>
                </div>
                <div class="stat-chip">
                  <span class="stat-chip-key">Words</span>
                  <span class="stat-chip-value" id="wordCount">0</span>
                </div>
              </div>
              <div class="hint-soft">
                Chat APIs add a small perâ€‘message overhead that is
                <strong>not included</strong> here.
              </div>
            </div>
          </div>
        </div>

        <div class="stats-grid">
          <div class="encoding-card">
            <div class="encoding-card-header">
              <div class="encoding-card-header-title">Token counts by encoding</div>
              <div class="small-pill">
                <span class="dot"></span>
                <span>Multiâ€‘model view</span>
              </div>
            </div>
            <div class="encoding-card-body">
              <table id="encodingTable">
                <thead>
                  <tr>
                    <th>Encoding / Models</th>
                    <th style="text-align:right">Count</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Rows populated via JS -->
                </tbody>
              </table>
            </div>
          </div>

          <div class="tokens-card">
            <div class="tokens-card-header">
              <div class="tokens-card-header-title">Token view (primary model)</div>
              <div class="small-pill" id="tokenViewInfo">up to 512 tokens visualized</div>
            </div>
            <div class="tokens-body" id="tokenInspector">
              <p class="muted">
                Start typing on the left to see how the selected model breaks your text
                into tokens. For very long prompts, this view is disabled to keep the
                browser responsive.
              </p>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <span>Counts are approximate for GPTâ€‘compatible models using the selected encoding.</span>
      <span>
        Library:
        <a href="https://www.npmjs.com/package/js-tiktoken" target="_blank" rel="noreferrer">jsâ€‘tiktoken</a>
      </span>
    </footer>
  </div>

  <!-- Logic: pure browser JS, using ES modules -->
  <script type="module">
    // Switch to js-tiktoken, a reliable, pure-JS port of OpenAI's tokenizer
    // Version 1.0.12+ includes support for o200k_base (GPT-4o)
    import { getEncoding } from "https://esm.sh/js-tiktoken@1.0.12";

    /**
     * Encodings we want to support.
     * These map closely to popular GPT-based models.
     */
    const ENCODING_CONFIGS = [
      {
        id: "o200k_base",
        label: "o200k_base",
        primaryFor: ["gpt-4o", "gpt-4o-mini", "gpt-4.1", "gpt-4.1-mini"],
        modelsLabel: "gptâ€‘4o, gptâ€‘4oâ€‘mini, gptâ€‘4.1, gptâ€‘4.1â€‘mini",
      },
      {
        id: "cl100k_base",
        label: "cl100k_base",
        primaryFor: ["gpt-4", "gpt-3.5-turbo"],
        modelsLabel: "gptâ€‘4, gptâ€‘3.5â€‘turbo, many chat models",
      },
      {
        id: "gpt2",
        label: "gpt2",
        primaryFor: [],
        modelsLabel: "GPTâ€‘2, GPTâ€‘J, GPTâ€‘NeoXâ€‘style models",
      },
      {
        id: "p50k_base",
        label: "p50k_base",
        primaryFor: [],
        modelsLabel: "textâ€‘davinciâ€‘003, older code models",
      },
      {
        id: "r50k_base",
        label: "r50k_base",
        primaryFor: [],
        modelsLabel: "legacy GPTâ€‘3 base models",
      },
    ];

    /**
     * Model presets for the dropdown.
     */
    const MODEL_PRESETS = [
      // Modern OpenAI models
      { id: "gpt-4o", name: "OpenAI Â· gptâ€‘4o", encoding: "o200k_base" },
      { id: "gpt-4o-mini", name: "OpenAI Â· gptâ€‘4oâ€‘mini", encoding: "o200k_base" },
      { id: "gpt-4.1", name: "OpenAI Â· gptâ€‘4.1", encoding: "o200k_base" },
      { id: "gpt-4.1-mini", name: "OpenAI Â· gptâ€‘4.1â€‘mini", encoding: "o200k_base" },

      // cl100k_base models
      { id: "gpt-4", name: "OpenAI Â· gptâ€‘4", encoding: "cl100k_base" },
      { id: "gpt-3.5-turbo", name: "OpenAI Â· gptâ€‘3.5â€‘turbo", encoding: "cl100k_base" },

      // Generic GPT-2 BPE models
      { id: "gpt2-compat", name: "Generic Â· GPTâ€‘2 / NeoXâ€‘style", encoding: "gpt2" },

      // Legacy
      { id: "text-davinci-003", name: "OpenAI Â· textâ€‘davinciâ€‘003", encoding: "p50k_base" },
      { id: "gpt3-legacy", name: "OpenAI Â· GPTâ€‘3 (legacy base)", encoding: "r50k_base" },
    ];

    // DOM elements
    const inputTextEl = document.getElementById("inputText");
    const pasteBtn = document.getElementById("pasteBtn");
    const clearBtn = document.getElementById("clearBtn");
    const inputMessageEl = document.getElementById("inputMessage");

    const primaryModelSelect = document.getElementById("primaryModel");
    const primaryTokensEl = document.getElementById("primaryTokens");
    const primaryModelLabelEl = document.getElementById("primaryModelLabel");
    const charCountEl = document.getElementById("charCount");
    const wordCountEl = document.getElementById("wordCount");
    const encodingTableBody = document.querySelector("#encodingTable tbody");
    const tokenInspectorEl = document.getElementById("tokenInspector");
    const tokenViewInfoEl = document.getElementById("tokenViewInfo");

    // Internal state
    const encodingInstances = new Map(); // encodingId -> encoding object
    const encodingAvailable = new Map(); // encodingId -> boolean
    const tokenCache = new Map();        // encodingId -> tokens (for latest text)

    /**
     * Utility: escape HTML to safely show raw token text
     */
    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    /**
     * Simple word count: split on whitespace
     */
    function countWords(str) {
      const trimmed = str.trim();
      if (!trimmed) return 0;
      return trimmed.split(/\s+/).length;
    }

    /**
     * Initialize tokenizer encodings
     */
    function initEncodings() {
      ENCODING_CONFIGS.forEach((config) => {
        try {
          // js-tiktoken allows calling getEncoding with standard names
          const enc = getEncoding(config.id);
          encodingInstances.set(config.id, enc);
          encodingAvailable.set(config.id, true);
        } catch (err) {
          console.error("Failed to init encoding", config.id, err);
          encodingAvailable.set(config.id, false);
        }
      });
    }

    /**
     * Populate the model dropdown and encoding table
     */
    function initUI() {
      // Model select
      MODEL_PRESETS.forEach((m, index) => {
        const opt = document.createElement("option");
        opt.value = m.id;
        opt.textContent = m.name;
        if (index === 0) {
          opt.selected = true;
        }
        primaryModelSelect.appendChild(opt);
      });

      // Encoding table
      ENCODING_CONFIGS.forEach((config) => {
        const tr = document.createElement("tr");
        tr.dataset.encoding = config.id;

        const nameTd = document.createElement("td");
        nameTd.className = "encoding-name-cell";
        nameTd.innerHTML = `
          <div style="display:flex;flex-direction:column;gap:2px;">
            <div>${config.label}</div>
            <div class="encoding-models">${config.modelsLabel}</div>
          </div>
        `;

        const countTd = document.createElement("td");
        countTd.className = "token-count-cell";
        countTd.textContent = "0";

        const statusTd = document.createElement("td");
        statusTd.innerHTML = `
          <span class="status-pill">
            <span class="status-dot"></span>
            <span>init</span>
          </span>
        `;

        tr.appendChild(nameTd);
        tr.appendChild(countTd);
        tr.appendChild(statusTd);
        encodingTableBody.appendChild(tr);
      });
    }

    /**
     * Get the currently selected model preset and its encoding
     */
    function getPrimaryModel() {
      const id = primaryModelSelect.value;
      return MODEL_PRESETS.find((m) => m.id === id) || MODEL_PRESETS[0];
    }

    /**
     * Update basic stats & per-encoding token counts
     */
    function updateTokenization() {
      const text = inputTextEl.value || "";
      tokenCache.clear();
      inputMessageEl.textContent = "";

      // Basic stats
      charCountEl.textContent = text.length.toLocaleString("en-US");
      wordCountEl.textContent = countWords(text).toLocaleString("en-US");

      // Per-encoding counts
      ENCODING_CONFIGS.forEach((config) => {
        const encodingId = config.id;
        const row = encodingTableBody.querySelector(`tr[data-encoding="${encodingId}"]`);
        if (!row) return;

        const countTd = row.children[1];
        const statusTd = row.children[2];

        const available = encodingAvailable.get(encodingId);
        if (!available) {
          countTd.textContent = "â€”";
          statusTd.innerHTML = `
            <span class="status-pill error">
              <span class="status-dot error"></span>
              <span>Unavailable</span>
            </span>
          `;
          row.classList.add("encoding-muted");
          return;
        }

        const enc = encodingInstances.get(encodingId);
        if (!enc) {
          countTd.textContent = "â€”";
          statusTd.innerHTML = `
            <span class="status-pill error">
              <span class="status-dot error"></span>
              <span>Error</span>
            </span>
          `;
          return;
        }

        try {
          const tokens = enc.encode(text);
          tokenCache.set(encodingId, tokens);
          countTd.textContent = tokens.length.toLocaleString("en-US");
          statusTd.innerHTML = `
            <span class="status-pill ok">
              <span class="status-dot ok"></span>
              <span>OK</span>
            </span>
          `;
        } catch (err) {
          console.error("Encoding error", encodingId, err);
          countTd.textContent = "error";
          statusTd.innerHTML = `
            <span class="status-pill error">
              <span class="status-dot error"></span>
              <span>Error</span>
            </span>
          `;
        }
      });

      updatePrimaryDetails();
    }

    /**
     * Update details for the selected primary model
     */
    function updatePrimaryDetails() {
      const model = getPrimaryModel();
      const encodingId = model.encoding;
      const text = inputTextEl.value || "";

      const available = encodingAvailable.get(encodingId);
      const encoding = encodingInstances.get(encodingId) || null;

      // Highlight primary encoding row
      Array.from(encodingTableBody.querySelectorAll("tr")).forEach((tr) => {
        const encId = tr.dataset.encoding;
        const countTd = tr.children[1];
        countTd.classList.toggle("primary", encId === encodingId);
      });

      if (!available || !encoding) {
        primaryTokensEl.textContent = "â€”";
        primaryModelLabelEl.textContent = `${model.name} â€¢ ${encodingId} (unavailable)`;
        tokenInspectorEl.innerHTML = `
          <p class="muted danger">
            The "${encodingId}" encoding is not supported by the loaded library.
          </p>
        `;
        return;
      }

      primaryModelLabelEl.textContent = `${model.name} Â· ${encodingId}`;

      let tokens = tokenCache.get(encodingId);
      if (!tokens) {
        try {
          tokens = encoding.encode(text);
          tokenCache.set(encodingId, tokens);
        } catch (err) {
          console.error("Encoding error for primary model", err);
          primaryTokensEl.textContent = "error";
          return;
        }
      }

      primaryTokensEl.textContent = tokens.length.toLocaleString("en-US");

      // Token visualization
      const tokenCount = tokens.length;
      const maxVisualTokens = 512;

      if (!text) {
        tokenInspectorEl.innerHTML = `
          <p class="muted">
            No input yet. Type or paste text on the left to inspect how
            <span class="muted-strong">${escapeHtml(model.name)}</span>
            tokenizes your prompt.
          </p>
        `;
        return;
      }

      if (tokenCount > maxVisualTokens) {
        tokenInspectorEl.innerHTML = `
          <p class="muted">
            The prompt is <span class="muted-strong">${tokenCount.toLocaleString("en-US")} tokens</span>.
            To keep things smooth, token visualization is disabled for inputs over
            <span class="muted-strong">${maxVisualTokens}</span> tokens.
          </p>
        `;
        tokenViewInfoEl.textContent = `visualization disabled (> ${maxVisualTokens} tokens)`;
        return;
      }

      tokenViewInfoEl.textContent = `showing ${tokenCount.toLocaleString("en-US")} tokens`;

      const fragment = document.createDocumentFragment();
      const list = document.createElement("div");
      list.className = "token-list";

      tokens.forEach((tokenId, index) => {
        let tokenText = "";
        try {
          // js-tiktoken decode expects an array of integers
          const bytes = encoding.decode([tokenId]);
          // In JS-tiktoken, decode returns a string directly (decoded from utf-8)
          // We can use it directly.
          tokenText = bytes;
        } catch {
          tokenText = "";
        }

        const chip = document.createElement("div");
        chip.className = "token-chip";
        chip.innerHTML = `
          <div class="token-text">${escapeHtml(tokenText)}</div>
          <div class="token-meta">
            <span class="token-index">#${index}</span>
            <span class="token-id">id ${tokenId}</span>
          </div>
        `;
        list.appendChild(chip);
      });

      fragment.appendChild(list);
      tokenInspectorEl.innerHTML = "";
      tokenInspectorEl.appendChild(fragment);
    }

    /**
     * Clipboard helpers
     */
    async function handlePasteClick() {
      if (!navigator.clipboard || !navigator.clipboard.readText) {
        inputMessageEl.textContent =
          "Clipboard API is not available in this browser or context.";
        return;
      }

      try {
        const text = await navigator.clipboard.readText();
        if (!text) {
          inputMessageEl.textContent = "Clipboard is empty or doesn't contain text.";
          return;
        }
        inputTextEl.value = text;
        updateTokenization();
        inputMessageEl.textContent = "Pasted from clipboard.";
      } catch (err) {
        console.error("Clipboard read failed", err);
        inputMessageEl.textContent =
          "Unable to read from clipboard. Your browser or permissions may be blocking it.";
      }
    }

    function handleClearClick() {
      inputTextEl.value = "";
      updateTokenization();
      inputMessageEl.textContent = "Input cleared.";
    }

    /**
     * Debounced input handler
     */
    let inputDebounce = null;
    function handleInputChange() {
      if (inputDebounce) {
        clearTimeout(inputDebounce);
      }
      inputDebounce = setTimeout(() => {
        updateTokenization();
        inputDebounce = null;
      }, 120);
    }

    /**
     * Initialization
     */
    function main() {
      initEncodings();
      initUI();
      // Initial run (in case of reload with form data preserved)
      updateTokenization();

      inputTextEl.addEventListener("input", handleInputChange);
      primaryModelSelect.addEventListener("change", updatePrimaryDetails);
      pasteBtn.addEventListener("click", handlePasteClick);
      clearBtn.addEventListener("click", handleClearClick);
    }

    main();
  </script>
</body>
</html>